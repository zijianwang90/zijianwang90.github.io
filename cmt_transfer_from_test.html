<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Batch Token Transfer</title>
    <style type="text/css">
        body {
            font-size: 4em;
        }

        button {
            font-size: 1em;
        }
    </style>
</head>

<script type="text/javascript">
    const crc20Abi = [
        {
            "constant": true,
            "inputs": [],
            "name": "name",
            "outputs": [
                {
                    "name": "",
                    "type": "string"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_spender",
                    "type": "address"
                },
                {
                    "name": "_value",
                    "type": "uint256"
                }
            ],
            "name": "approve",
            "outputs": [
                {
                    "name": "",
                    "type": "bool"
                }
            ],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "property",
            "outputs": [
                {
                    "name": "",
                    "type": "string"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "totalSupply",
            "outputs": [
                {
                    "name": "",
                    "type": "uint256"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "document",
            "outputs": [
                {
                    "name": "",
                    "type": "string"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_from",
                    "type": "address"
                },
                {
                    "name": "_to",
                    "type": "address"
                },
                {
                    "name": "_value",
                    "type": "uint256"
                }
            ],
            "name": "transferFrom",
            "outputs": [
                {
                    "name": "",
                    "type": "bool"
                }
            ],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_logo",
                    "type": "string"
                }
            ],
            "name": "setLogo",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "INITIAL_SUPPLY",
            "outputs": [
                {
                    "name": "",
                    "type": "uint256"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "decimals",
            "outputs": [
                {
                    "name": "",
                    "type": "uint8"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [],
            "name": "unpause",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "founder",
            "outputs": [
                {
                    "name": "",
                    "type": "address"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_property",
                    "type": "string"
                }
            ],
            "name": "setProperty",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_document",
                    "type": "string"
                }
            ],
            "name": "setDocument",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "version",
            "outputs": [
                {
                    "name": "",
                    "type": "uint8"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "paused",
            "outputs": [
                {
                    "name": "",
                    "type": "bool"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_spender",
                    "type": "address"
                },
                {
                    "name": "_subtractedValue",
                    "type": "uint256"
                }
            ],
            "name": "decreaseApproval",
            "outputs": [
                {
                    "name": "success",
                    "type": "bool"
                }
            ],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "links",
            "outputs": [
                {
                    "name": "",
                    "type": "string"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [
                {
                    "name": "_owner",
                    "type": "address"
                }
            ],
            "name": "balanceOf",
            "outputs": [
                {
                    "name": "",
                    "type": "uint256"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [],
            "name": "renounceOwnership",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "description",
            "outputs": [
                {
                    "name": "",
                    "type": "string"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [],
            "name": "pause",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "issueDate",
            "outputs": [
                {
                    "name": "",
                    "type": "uint256"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "owner",
            "outputs": [
                {
                    "name": "",
                    "type": "address"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "symbol",
            "outputs": [
                {
                    "name": "",
                    "type": "string"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "rights",
            "outputs": [
                {
                    "name": "",
                    "type": "string"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_to",
                    "type": "address"
                },
                {
                    "name": "_value",
                    "type": "uint256"
                }
            ],
            "name": "transfer",
            "outputs": [
                {
                    "name": "",
                    "type": "bool"
                }
            ],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_logo",
                    "type": "string"
                },
                {
                    "name": "_webSite",
                    "type": "string"
                },
                {
                    "name": "_links",
                    "type": "string"
                },
                {
                    "name": "_rights",
                    "type": "string"
                },
                {
                    "name": "_description",
                    "type": "string"
                }
            ],
            "name": "updateProfile",
            "outputs": [],
            "payable": true,
            "stateMutability": "payable",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "crowdFunding",
            "outputs": [
                {
                    "name": "",
                    "type": "address"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "freezenAmount",
            "outputs": [
                {
                    "name": "",
                    "type": "uint256"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "website",
            "outputs": [
                {
                    "name": "",
                    "type": "string"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [
                {
                    "name": "_founder",
                    "type": "address"
                },
                {
                    "name": "_amount",
                    "type": "uint256"
                }
            ],
            "name": "isFounderFreezen",
            "outputs": [
                {
                    "name": "",
                    "type": "bool"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_spender",
                    "type": "address"
                },
                {
                    "name": "_addedValue",
                    "type": "uint256"
                }
            ],
            "name": "increaseApproval",
            "outputs": [
                {
                    "name": "success",
                    "type": "bool"
                }
            ],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_contractAddress",
                    "type": "address"
                },
                {
                    "name": "_tokenAmount",
                    "type": "uint256"
                }
            ],
            "name": "setCrowdFunding",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [
                {
                    "name": "_owner",
                    "type": "address"
                },
                {
                    "name": "_spender",
                    "type": "address"
                }
            ],
            "name": "allowance",
            "outputs": [
                {
                    "name": "",
                    "type": "uint256"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "freezenTime",
            "outputs": [
                {
                    "name": "",
                    "type": "uint256"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_newOwner",
                    "type": "address"
                }
            ],
            "name": "transferOwnership",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": false,
            "inputs": [
                {
                    "name": "_webSite",
                    "type": "string"
                }
            ],
            "name": "setWebsite",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "logo",
            "outputs": [
                {
                    "name": "",
                    "type": "string"
                }
            ],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "name": "_name",
                    "type": "string"
                },
                {
                    "name": "_symbol",
                    "type": "string"
                },
                {
                    "name": "_decimals",
                    "type": "uint8"
                },
                {
                    "name": "_supply",
                    "type": "uint256"
                },
                {
                    "name": "_freezenAmount",
                    "type": "uint256"
                },
                {
                    "name": "_freezenTime",
                    "type": "uint256"
                }
            ],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "constructor"
        },
        {
            "anonymous": false,
            "inputs": [
                {
                    "indexed": false,
                    "name": "tokenName",
                    "type": "string"
                },
                {
                    "indexed": false,
                    "name": "logo",
                    "type": "string"
                },
                {
                    "indexed": false,
                    "name": "webSite",
                    "type": "string"
                },
                {
                    "indexed": false,
                    "name": "links",
                    "type": "string"
                },
                {
                    "indexed": false,
                    "name": "rights",
                    "type": "string"
                },
                {
                    "indexed": false,
                    "name": "description",
                    "type": "string"
                }
            ],
            "name": "ProfileHistory",
            "type": "event"
        },
        {
            "anonymous": false,
            "inputs": [],
            "name": "Pause",
            "type": "event"
        },
        {
            "anonymous": false,
            "inputs": [],
            "name": "Unpause",
            "type": "event"
        },
        {
            "anonymous": false,
            "inputs": [
                {
                    "indexed": true,
                    "name": "previousOwner",
                    "type": "address"
                }
            ],
            "name": "OwnershipRenounced",
            "type": "event"
        },
        {
            "anonymous": false,
            "inputs": [
                {
                    "indexed": true,
                    "name": "previousOwner",
                    "type": "address"
                },
                {
                    "indexed": true,
                    "name": "newOwner",
                    "type": "address"
                }
            ],
            "name": "OwnershipTransferred",
            "type": "event"
        },
        {
            "anonymous": false,
            "inputs": [
                {
                    "indexed": true,
                    "name": "owner",
                    "type": "address"
                },
                {
                    "indexed": true,
                    "name": "spender",
                    "type": "address"
                },
                {
                    "indexed": false,
                    "name": "value",
                    "type": "uint256"
                }
            ],
            "name": "Approval",
            "type": "event"
        },
        {
            "anonymous": false,
            "inputs": [
                {
                    "indexed": true,
                    "name": "from",
                    "type": "address"
                },
                {
                    "indexed": true,
                    "name": "to",
                    "type": "address"
                },
                {
                    "indexed": false,
                    "name": "value",
                    "type": "uint256"
                }
            ],
            "name": "Transfer",
            "type": "event"
        }
    ];

    // const batchTransferContract = "0x8bd0ca5bd30777596a8a7d984d00194543114ae3";//test
    const batchTransferContract = "0xa5d0ae3c469137093e634cea1f999ba75b9306f2";//main

    const batchTransferAbi = [
        {
            "constant": false,
            "inputs": [
                {
                    "name": "tokenAddr",
                    "type": "address"
                },
                {
                    "name": "toAddr",
                    "type": "address[]"
                },
                {
                    "name": "value",
                    "type": "uint256[]"
                }
            ],
            "name": "batch",
            "outputs": [
                {
                    "name": "",
                    "type": "bool"
                }
            ],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        }
    ];

    let addressData = [];
    let amountData = [];
    let addrRegex = RegExp("^0x[a-fA-F0-9]{40}$");

    function doApprove() {
        let crc20Contract = document.getElementById("contract_addr").value;
        let approveAmount = document.getElementById("approve_amount").value;
        if (!addrRegex.test(crc20Contract)) {
            alert("You need give me a fucking legit CONTRACT ADDRESS!!!!");
            return;
        }

        alert(approveAmount);
        if (!approveAmount && approveAmount <= 0) {
            alert("Motherfuck!!! Gimme a fucking right approve amount!!");
            return;
        }

        let contractInstance = window.web3.cmt.contract(crc20Abi).at(crc20Contract);

        contractInstance.approve(batchTransferContract, web3.toWei(approveAmount, "ether"), function (err, data){
            if (err) {
                console.log(err);
            } else {
                console.log(data);
            }
        });

        let approveInfo = contractInstance.Approval();
        approveInfo.watch(function (e, data) {
            if (!e) {
                alert("Fucking Approved Successfully!!! Congratulations motherfucker!!!" + data.transactionHash);
            } else {
                alert(e)
            }
        });
    }

    function doUpload() {
        const files = document.getElementById("file-value").files;
        if(files.length) {
            const file = files[0];
            addressData = [];
            amountData = [];

            const reader = new FileReader(); //new一个FileReader实例
            if(typeof FileReader === 'undefined') {
                layer.alert("你的浏览器暂不支持该功能", {title: "提示", skin: "layui-layer-molv"});
                file.setAttribute("disabled", "disabled");
                return;
            }
            reader.readAsText(file);
            reader.onload = function(f) {
                //显示文件
                var relArr = this.result.split("\r\n");
                if(relArr.length > 1) {
                    for(let key = 0, len = relArr.length; key < len; key++) {
                        var values = relArr[key];
                        var objArr = values.split(",");
                        var addr = objArr[0];
                        var amount = objArr[1];
                        if (!addrRegex.test(addr)) {
                            alert("Some addresses ain't fucking look right: " + addr);
                            addressData = [];
                            amountData = [];
                            return;
                        }
                        if (!amount && amount <= 0) {
                            alert("Some amounts ain't fucking look right: " + amount);
                            addressData = [];
                            amountData = [];
                            return;
                        }

                        addressData.push(objArr[0]);
                        amountData.push(BigInt(web3.toWei(objArr[1], "ether")));
                    }
                }
                document.getElementById("address_data").innerHTML = addressData;
                document.getElementById("amount_data").innerHTML = amountData;
                console.log(addressData);
                console.log(amountData);
            }
        }
    }

    function doTransfer() {
        let crc20Contract = document.getElementById("contract_addr").value;
        if (!addrRegex.test(crc20Contract)) {
            alert("You need give me a fucking legit CONTRACT ADDRESS!!!!");
            return;
        }

        if (addressData.length > 0
            && amountData.length > 0
            && addressData.length === amountData.length
            && addrRegex.test(crc20Contract)) {

            let batchTransferContractInstance = window.web3.cmt.contract(batchTransferAbi).at(batchTransferContract);

            let data = batchTransferContractInstance.batch.getData(crc20Contract, addressData, amountData);

            if (data) {
                web3.cmt.getAccounts(function (e, accounts) {
                    if (accounts) {
                        web3.cmt.sendTransaction({to: batchTransferContract, from: accounts[0], data: data}, function (err, data) {
                            if (err) {
                                alert("Batch transfer fucking failed!!!! " + err);
                                console.log(err)
                            } else {
                                alert("Batch transfer fucking succeeded!!!! " + data);
                                console.log(data)
                            }
                        });
                    }
                });
            }
        } else {
            alert("something ain't fucking right!!! Asshole!!!")
        }
    }

    function start() {
        document.getElementById("approve").addEventListener("click", doApprove);
        document.getElementById("upload").addEventListener("click", doUpload);
        document.getElementById("transfer").addEventListener("click", doTransfer);

        var defaultAccountInterval = setInterval(function () {
            if (web3.cmt.defaultAccount) {
                clearInterval(defaultAccountInterval);
                document.getElementById("address").innerHTML = web3.cmt.defaultAccount;
                web3.cmt.getBalance(web3.cmt.defaultAccount, function (err, balance) {
                    document.getElementById("balance").innerHTML = balance;
                });
            }
        }, 1000);

        setInterval(function () {
            web3.currentProvider.sendAsync({
                jsonrpc: '2.0', id: 1, method: 'net_version', params: []
            }, function (err, x) {
                if (err) {
                    document.getElementById("jsonrpcNetworkId").innerHTML = "ERROR: " + err;
                } else if (x.result != web3.version.network) {
                    document.getElementById("jsonrpcNetworkId").innerHTML = "ERROR: web3.version.network = " + web3.version.network + ", net_version = " + x.result;
                } else {
                    document.getElementById("jsonrpcNetworkId").innerHTML = x.result;
                }
            });
        }, 10000);

        setInterval(function () {
            web3.currentProvider.sendAsync({
                jsonrpc: '2.0', id: 2, method: 'eth_blockNumber', params: []
            }, function (err, x) {
                if (x.error) {
                    document.getElementById("blockNumber").innerHTML = x.error.message;
                } else {
                    document.getElementById("blockNumber").innerHTML = x.result;
                }
            });
        }, 10000);
    }

    var startInterval = setInterval(function () {
        if (window.web3) {
            start();
            clearInterval(startInterval);
            document.getElementById("MISSINGWEB3").innerHTML = "Batch Transfer";
        } else {
            document.getElementById("MISSINGWEB3").innerHTML = "MISSING WEB3";
        }
    }, 1000);
</script>

<body>
<h2 id="MISSINGWEB3"></h2>
<p>
    You are <span id="address"></span><br/>
    Balance <span id="balance"></span><br/>
    network id: <span id="jsonrpcNetworkId"></span><br/>
    block number: <span id="blockNumber"></span>
</p>

<p>
<div>
    <input class="contract_addr" type="text" placeholder="Contract Address" id="contract_addr">
</div>
</p>

<p>
<div>
    <input class="approve_amount" type="number" placeholder="Approve Amount" id="approve_amount">
</div>
</p>

<p>
    <button id="approve">Approve</button>
</p>

<div>
    <fieldset class="form-group col-xs-3 col-lg-offset-3">
        <input type="file" class="form-control" id="file-value" />
    </fieldset>
    <button id="upload">Upload CSV</button>
</div>

<div id="address_data"></div>

<div id="amount_data"></div>

<p>
    <button id="transfer">Trigger Transfer!!</button>
</p>
<!--<p>-->
<!--<div>-->
    <!--<div>是否打赏开发者（王子健）：</div>-->
    <!--<input type="radio" name="tip_developer" value="true" id="tip_true" checked="checked"> True<br>-->
    <!--<input type="radio" name="tip_developer" value="false" id="tip_false"> False<br>-->
<!--</div>-->
<!--</p>-->
</body>
</html>